---
title: "é †ã‚’è¿½ã£ã¦ç†è§£ã™ã‚‹Stateãƒ¢ãƒŠãƒ‰ã®å®Ÿè£…"
emoji: "ğŸ˜"
type: "tech"
topics: ["haskell"]
published: true
---
çªç„¶ã§ã™ãŒã€Stateãƒ¢ãƒŠãƒ‰ã®å®Ÿè£…ã‚’æ›¸ã‘ã¾ã™ã‹ï¼Ÿ

Stateãƒ¢ãƒŠãƒ‰ã¯**è‡ªç”±ã«èª­ã¿æ›¸ãå¯èƒ½ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ã‚ˆã†ãªæ©Ÿèƒ½**ã‚’ã€å‰¯ä½œç”¨ã‚’ä¼´ã‚ãªã„ç´”ç²‹ãªé–¢æ•°ã ã‘ã‚’ä½¿ã£ã¦å®Ÿè£…ã™ã‚‹ãŸã‚ã®ä¾¿åˆ©ãªæ¦‚å¿µã§ã™ã€‚ä½¿ã†ã ã‘ãªã‚‰ç°¡å˜ãªã®ã§æ™®æ®µã‹ã‚‰ä¾¿åˆ©ã«åˆ©ç”¨ã—ã¦ã‚‹äººã‚‚å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã„ã–è‡ªåˆ†ã§å®Ÿè£…ã—ã‚ã¨è¨€ã‚ã‚Œã‚‹ã¨æ‰‹ãŒæ­¢ã¾ã£ã¦ã—ã¾ã†æ–¹ã‚‚ã„ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ä»Šå›ã¯ãã‚“ãªStateãƒ¢ãƒŠãƒ‰ã®å®Ÿè£…ã‚’ä¸å¯§ã«è¦‹ã¦ã„ãã€ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## State

ã•ã£ããä»¥ä¸‹ã«ç¤ºã™ã®ãŒStateãƒ¢ãƒŠãƒ‰ã®å‹ã®å®šç¾©ã§ã™[^1]ã€‚

```hs
newtype State s a = State { runState :: s -> (s, a) }
```

ã¾ãš`State`ã¯[newtype](https://qiita.com/Izawa_/items/9e641d7145fb9d4c4155)ã‚’ä½¿ã£ã¦é–¢æ•°ã¨åŒã˜å‹ã¨ã—ã¦å®šç¾©ã•ã‚Œã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ä»¥ä¸‹ã®æ§‹é€ ã‚’æ„è­˜ã—ã¦ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/fho29o47y8zljgq91xmrbxe9ky9t)

å®Ÿè¡Œå‰å¾Œã§çŠ¶æ…‹ã®å‹ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ãŒã€å€¤ã«é–¢ã—ã¦ã¯å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ã€‚

ãƒ¢ãƒŠãƒ‰ã«ã™ã‚‹ãŸã‚ã«ã¯`Functor`ã¨`Applicative`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Functor

ã¾ãšã¯`Functor`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```hs
instance Functor (State s) where
  fmap f (State g) = State $ \s ->
    let (s', a) = g s
     in (s', f a)
```

- 2è¡Œç›®: è¿”ã‚Šå€¤ã§ã‚ã‚‹`State`ã®å®Ÿæ…‹ã¯é–¢æ•°ãªã®ã§å€¤ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã€"å‰ã®çŠ¶æ…‹"ã‚’é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ï¼ˆ`\s ->`ï¼‰å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- 3è¡Œç›®: å¼•æ•°ã¨ã—ã¦å—ã‘å–ã£ãŸ"å‰ã®çŠ¶æ…‹"ã‚’ä½¿ã£ã¦é–¢æ•°`g`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãŸã ã—ã“ã“ã¯é–¢æ•°å®šç¾©ã®ä¸­ãªã®ã§ã€å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯ä»Šå®šç¾©ã—ã¦ã„ã‚‹é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã§ã™ã€‚`g`ã‚’å®Ÿè¡Œã—ãŸçµæœã¨ã—ã¦æ¬¡ã®çŠ¶æ…‹`s'`ã¨å®Ÿè¡Œçµæœ`a`ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
- 4è¡Œç›®: ä»Šæ§‹ç¯‰ã—ã¦ã„ã‚‹`State`ã®å®Ÿè¡Œå¾Œã®çŠ¶æ…‹ã¨ã—ã¦ã¯`s'`ã‚’ã€ãã—ã¦ä»Šå®Ÿè£…ã—ãŸã‹ã£ãŸã®ã¯`Functor`ã®`fmap`ãªã®ã§`f a`ã‚’å®Ÿè¡Œçµæœã¨ã—ã¦ã‚¿ãƒ—ãƒ«ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚

é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦å°å…¥ã—ãŸ"å‰ã®çŠ¶æ…‹"ã‚’ä½¿ã£ã¦"æ¬¡ã®çŠ¶æ…‹"ã‚’å·§ã¿ã«å¾—ã¦ã„ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

## Applicative

`Functor`ã¨åŒæ§˜ã«`Applicative`ã‚‚å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```hs
instance Applicative (State s) where
  pure a = State $ \s -> (s, a)
  (State f) <*> (State g) = State $ \s ->
    let (s', h) = f s
        (s'', a) = g s'
     in (s'', h a)
```

`pure`ã®å‹ãŒ`a -> State s a`, `<*>` ã®å‹ãŒ`State s (a -> b) -> State s a -> State s b`ã§ã‚ã‚‹ã“ã¨ã‚’æ€ã„å‡ºã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

- 2è¡Œç›®: `pure` ã¯çŠ¶æ…‹ã‚’å¤‰åŒ–ã™ã‚‹ã“ã¨ãªãå·¦ã‹ã‚‰å³ã«æµã—ãªãŒã‚‰ã€ä¸ãˆã‚‰ã‚ŒãŸå€¤ã‚’å®Ÿè¡Œçµæœã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
- 3è¡Œç›®: `State` ãŒé–¢æ•°ã§ã‚ã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ã¦ã€å¼•æ•°ã¨ã—ã¦å‰ã®çŠ¶æ…‹`s`ã‚’å°å…¥ã—ã¾ã™
- 4è¡Œç›®: ã¾ãš`f :: s -> (s, a -> b)` ã‚’"å‰ã®çŠ¶æ…‹"`s`ã§è©•ä¾¡ã™ã‚‹ã“ã¨ã§ã€æ¬¡ã®çŠ¶æ…‹`s'`ã¨å®Ÿè¡Œçµæœ`h :: a -> b`ã‚’å¾—ã¾ã™ã€‚
- 5è¡Œç›®: 4è¡Œç›®ã§å¾—ã‚‰ã‚ŒãŸæ¬¡ã®çŠ¶æ…‹`s'`ã‚’ä½¿ã£ã¦æ›´ã«`g`ã‚’è©•ä¾¡ã™ã‚‹ã“ã¨ã§ã€æ¬¡ã®æ¬¡ã®çŠ¶æ…‹`s''`ã¨å®Ÿè¡Œçµæœ`a`ã‚’å¾—ã¾ã™ã€‚
- 6è¡Œç›®: æ¬¡ã®æ¬¡ã®çŠ¶æ…‹`s''`ã¨å®Ÿè¡Œçµæœ`h a`ã®ã‚¿ãƒ—ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

å°‘ã—ç…©é›‘ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä¸ãˆã‚‰ã‚ŒãŸ`State`ã‚’**é †ç•ªã«ã€çŠ¶æ…‹ã‚’æ›´æ–°ã—ãªãŒã‚‰å®Ÿè¡Œ**ã—ã¦ã„ãæœ€å¾Œã«è¨ˆç®—ã—ãŸã‹ã£ãŸå€¤`h a`ã¨æœ€çµ‚çš„ãªçŠ¶æ…‹`s''`ã‚’è¿”ã—ã¦ã„ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

ã¾ã‚‹ã§"çŠ¶æ…‹"ã¨ã„ã†æ°´ãŒæµã‚Œã‚‹é…ç®¡ã‚’ã†ã¾ãã¤ãªãåˆã‚ã›ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ï¼

![](https://storage.googleapis.com/zenn-user-upload/ydo5yrex8vjswud0oy6bokalnnty =200x)

## Monad

`Applicative`ã®å®Ÿè£…ãŒç†è§£ã§ãã‚Œã°`Monad`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å®Ÿè£…ã¯ç°¡å˜ã§ã™ã€‚

```hs
instance Monad (State s) where
  f >>= m = State $ \s ->
    let (s', a) = runState f s
     in runState (m a) s'
```

`>>=` ã®å‹ãŒ`State s a -> (a -> State s b) -> State s b`ã§ã‚ã‚‹ã“ã¨ã‚’æ€ã„å‡ºã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

- 2è¡Œç›®: ãŠæ±ºã¾ã‚Šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã­ã€‚`State` ãŒé–¢æ•°ã§ã‚ã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ã¦ã€å¼•æ•°ã¨ã—ã¦å‰ã®çŠ¶æ…‹`s`ã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚
- 3è¡Œç›®: 1ã¤ç›®ã®`State`ã®å®Ÿæ…‹ã§ã‚ã‚‹`f`ã‚’"å‰ã®çŠ¶æ…‹"ã‚’ä½¿ã£ã¦è©•ä¾¡ã—ã€æ¬¡ã®çŠ¶æ…‹`s'`ã¨å®Ÿè¡Œçµæœ`a`ã‚’å¾—ã¾ã™ã€‚
- 4è¡Œç›®: ãƒ¢ãƒŠãƒ‰ã®å ´åˆ2ã¤ç›®ã®`State`ãŒ3è¡Œç›®ã§è¨ˆç®—ã—ãŸå®Ÿè¡Œçµæœã‚’ä½¿ã‚ãªã„ã¨æ‰‹ã«å…¥ã‚‰ãªã„ã®ã§ã€ã¾ãš`m a`ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚ãã®çµæœã«`runState`ã‚’è¡Œã„é€šå¸¸ã®é–¢æ•°ã«ã—ãŸã¨ã“ã‚ã§ã€`s'`ã‚’ä½¿ã£ã¦è©•ä¾¡ã—ã€æœ€çµ‚çš„ãªçµæœã‚’å¾—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã§ãƒ¢ãƒŠãƒ‰ã®å®Ÿè£…ã¯çµ‚ã‚ã‚Šã§ã™ã€‚

ç´”ç²‹ãªé–¢æ•°ã ã‘ã‹ã‚‰ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’ç”Ÿã¿å‡ºã™Stateãƒ¢ãƒŠãƒ‰ã¯é­”æ³•ã®ã‚ˆã†ã§å®Ÿè£…ã¯é›£è§£ã«æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€é †ã‚’è¿½ã£ã¦ç†è§£ã™ã‚Œã°"çŠ¶æ…‹"ã®æµã‚Œã‚’ã†ã¾ãé…ç·šã—ã¦ã„ã£ã¦ã‚‹æ§˜å­ãŒã‚ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚Stateãƒ¢ãƒŠãƒ‰ã‚‚ã€Œãªã‚“ã ã“ã‚“ãªã‚‚ã®ã‹ã€ã¨æ€ã£ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ğŸ¤—

----

ï¼¼èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ï¼
ã“ã®è¨˜äº‹ãŒé¢ç™½ã‹ã£ãŸã‚‰ ã„ã„ã­â™¡ ã‚’ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™â˜ºï¸
100å††ã‹ã‚‰ã§ã‚‚ ã‚µãƒãƒ¼ãƒˆÂ¥ ã‚’ã„ãŸã ã‘ã‚Œã°æ¬¡ã®è¨˜äº‹ã‚’æ›¸ããŸã‚åŠ±ã¿ã«ãªã‚Šã¾ã™ğŸ™Œ

[^1]: Stateãƒ¢ãƒŠãƒ‰ã‚’å«ã‚€ä»£è¡¨çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ [transformers](https://hackage.haskell.org/package/transformers-0.5.6.2/docs/Control-Monad-Trans-State-Lazy.html) ã§ã¯è¿”ã‚Šå€¤ã®ã‚¿ãƒ—ãƒ«ãŒé€†ã§ `s -> (a, s)` ã¨å®šç¾©ã•ã‚Œã¦ã„ã¾ã™